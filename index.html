
<html>
<head>
    <script src="https://cdn.firebase.com/js/client/2.2.4/firebase.js">
                     </script>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/2.1.3/jquery.min.js">
    </script>
    <script>
    function testAuth() {
        var fbref = new Firebase("https://ccim2.firebaseio.com/keys/")
        var key = localStorage.getItem("key");
                fbref.child(key).set(null)
        if (sessionStorage.getItem("auth") === "true") {
            fbref.authWithCustomToken(localStorage.getItem("token"), function(error, authData) {
              if (error) {
                console.log("Login Failed!", error);
              } else {
                console.log("Login Succeeded!", authData);
              }
            });
            return true;
        } else {
            return false;
        }
    }
    if (!testAuth()) {
        window.location.href = "/login.html";
    }
    

    </script>
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/font-awesome/4.5.0/css/font-awesome.min.css">

    <noscript>
        <meta http-equiv="refresh"
        content="0; url=http://im.clubcoder.tk/noscript.html">
    </noscript>
    <style>
    #message {

        height:55%;
        overflow:scroll;
    }
    body {
        background-image: url("backgrounds/28.jpg");
        background-size:     cover;                      /* <------ */
        background-repeat:   no-repeat;
        background-position: center center; 

    }
    #message {
        .margin-bottom:;
        -moz-box-shadow:    inset  0  8px 4px -8px #696868, 
        inset  0 -8px 4px -8px #696868;
        -webkit-box-shadow: inset  0  8px 4px -8px #696868, 
        inset  0 -8px 4px -8px #696868;
        box-shadow:        inset  0  8px 4px -8px #696868, 
        inset  0 -8px 4px -8px #696868;

    }
    #message:hover {
        -moz-box-shadow:    inset  0  8px 14px -8px #696868, 
        inset  0 -8px 14px -8px #696868;
        -webkit-box-shadow: inset  0  8px 14px -8px #696868, 
        inset  0 -8px 14px -8px #696868;
        box-shadow:        inset  0  8px 14px -8px #696868, 
        inset  0 -8px 14px -8px #696868;
    }
    #message {
        background:rgba(255,255,255,0.5);
        border-radius: 2px
    }
    .intro {
        background:rgba(255,255,255,0.3);
    }
    #text {
        resize:vertical;
        background:rgba(255,255,255,0.5);
        color:rgba(0,0,0,1);
    }
    .background-transparent {
        background:rgba(255,255,255,0.5);
    }
    .transparent {
        opacity:0.7;
    }
    
    </style>

    <link href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-1q8mTJOASx8j1Au+a5WDVnPi2lkFfwwEAa8hDDdjZlpLegxhjVME1fgjWPGmkzs7" crossorigin="anonymous">

</head>
<body>
	<div class="container">


		<div class="row">
			<div class="box">
				<div class="col-lg-12">
					<br>

					<h1 class="intro">Welcome to the Club Coder instant messenger</h1>
					<br>
                    <noscript></noscript>
                    <div id="message" class="col-lg-12"></div>
                    <br>
                    <textarea placeholder="type a message!" id="text" class="form-control" class="text-ab45"></textarea>
                    <br>
                    <button class="form-control btn btn-success transparent" id="submit">Enter</button>
                    <div class="popout-hidden">
                        <div class="options background-transparent"><p> <a id="popout">Pop Out <i class="fa fa-external-link"></i></a>
                         | <span><a id="view-image">View Image <i class="fa fa-picture-o"></i>
</a></span> | <a id="logout">Logout <i class="fa fa-sign-out"></i></a> | <a id="help">Help <i class="fa fa-info-circle"></i></a></p></div>
                     </div>

                     <footer><div class="container"><div class="col-lg-12 background-transparent"><p>&copy; 2015-2016 Jeffrey Meng All Rights Reserved.</p></div></div></footer>

                     
                     <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/js/bootstrap.min.js" integrity="sha384-0mSbJDEHialfmuBBQP6A4Qrprq5OVfW37PRR3j5ELqxss1yVqOtnepnHVP9aJ7xS" crossorigin="anonymous"></script>

                     <script>
                     if (window.location.hash === "#popout") {
                        $(".popout-hidden").hide()
                        $(".intro").html("CCIM")
                        $("#message").css('height','45%')
                        $("#text").css("height", "auto")

                    }

                    $("#logout").click(function(){
                        var fbref = new Firebase("https://ccim2.firebaseio.com")
                        fbref.unauth();
                        localStorage.setItem("auth", "false");
                        window.location.href = "/logout.html"
                    })
                    $(document).ready(function(){$('#message').scrollTop($('#message')[0].scrollHeight);});
                    slide();
			function randoms() { // random
				return Math.floor(Math.random() * 50 + 1);
			}
            $("#help").click(function(){$("#myModal").modal("show")})
			function slide(){
                var z = randoms()
                $('body')
                .css('background-image','url("'+ 'http://im.clubcoder.tk/backgrounds/' + z + '.jpg' +'")')
                .fadeIn(300000,function(){
                 setTimeout(slide,300000);
             });
                $("#view-image").attr("href", 'http://im.clubcoder.tk/backgrounds/' + z + '.jpg')
            }
            var fb = new Firebase("https://ccim2.firebaseio.com/messages/");
            var doc = jQuery(document);
            doc.ready(setup);
            function fulltime() {
                var year = new Date();
                var month = new Date();
                var day = new Date();
                var hour = new Date();
                var minute = new Date();
                if (hour.getHours() > 12 ) {
                    var h = hour.getHours() -12
                    var a = " A.M."
                } else {
                    var h = hour.getHours()
                    var a = " P.M."
                }
                if (minute.getMinutes().length === 1) {
                    var m = "0" + minute.getMinutes();
                } else {
                    var m = minute.getMinutes();
                }
                var fulltime = month.getMonth()+1 + "/" + day.getDate() + "/" + year.getFullYear() + "  " + h + ":" + m + a + " ";
                return fulltime;
            }
            function setup() {
                $('#message').scrollTop($('#message')[0].scrollHeight)
                var button;
                button = jQuery("#submit");
                button.click(s);
                $("#popout").click(popout);
                fb.on("child_added", received);


            }
            String.prototype.replaceAll = function(search, replacement) {
    var target = this;
    return target.replace(new RegExp(search, 'g'), replacement);
};
            function popout() {
                var x = window.open('/#popout', 'test', 'status=no,location=no,toolbar=no,menubar=no,width=300,height=500')
            }
            function received(message) {
                var head;
                head = jQuery("#message");
                var m = message.val()
                if (m.indexOf("/") === 0) {
                    console.log("private:" + m)
                    var command = m.substring(1, m.indexOf("/header/") );

                    var other = m.substring(m.indexOf("/header/") + 8, m.indexOf("/end/"))
                    var note = m.substring(m.indexOf("/end/") + 5)
                    console.log("command: " + command + " other: " + other + " note: " + note)
                    if (command === "after") {
                        $('#message').scrollTop($('#message')[0].scrollHeight)
                    } else if (command === "private"){
                        if (note.indexOf(localStorage.getItem("username")) > -1 ) {
                            head.append("<p>" + note + "</p>");
                            console.log("to you")
                        } else {
                            console.log("fail")
                        }
                    }
                    
                } else {
                    head.append("<p>" + m + "</p>");
                }
            }
            $(document).keypress(function(e) {
                if(e.which == 13) {
                    s()
                    return false;
                    e.preventDefualt;
                }
            });
            function runCommand(c) {
                var command = c.substring(c.indexOf("/") + 1, c.indexOf("["))
                console.log(command)
                if (command === "msg") {
                    var recipents = c.substring(c.indexOf("/msg[") + 5, c.indexOf("]"))
                    var message = c.substring(c.indexOf("] ") + 2)
                    var topush = "/private/header/" + recipents + "/end/" + fulltime() + id + + " to " + recipents.replaceAll(" ", " and ") + ": " + message;
                     fb.push(topush);
                     $('#text').val('');

                }

            }
            function s() {
                var id = localStorage.getItem("username")
                var input;
                input = jQuery("#text");
                var message = input.val();
                if (message.indexOf("/") === 0) {
                 runCommand(message);
                 $('#text').val('');
             } else if (message === null || message === "" || message === " " || message === "\n") {
                return;
            } else {

             var topush = fulltime() + id + ": " + message;
             fb.push(topush);
             $('#text').val('');
         }


     }
     </script>
 </div>
</div>
</div>

</div>
<div id="myModal" class="modal fade" role="dialog">
  <div class="modal-dialog">

    <!-- Modal content-->
    <div class="modal-content">
      <div class="modal-header">
        <button type="button" class="close" data-dismiss="modal">&times;</button>
        <h4 class="modal-title">Help</h4>
      </div>
      <div class="modal-body">
        <p>Type in a message and press enter or click enter to send. Messages cannot be just a space, empty, or start with a slash(If a message starts with a slash, it is a command see below). To create a new line, type in \n note. Markdown is enabled(see below).</p>
        <h4>Commands</h4>
        <p>There is currently only one command you can use.</p>
        <p>
            /msg sends a private message. It's syntax is: <code>/msg[recipents] &lt;message></code>, where <cpde>recipents</code> is a space seperated list of recipents, For example: <code>/msg[joe bob billy] &lt;message></code> sengs a message to joe, bob, and billy only. No one else can see it.
            The <code>&lt;message></code> parameter is your message. for example: if you do <code>/msg [billy] Hello. Only you can see this.</code><br>
            Only billy and you will be able to see the message, which is:  Hello. Only you can see this.
        </p>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
      </div>
    </div>

  </div>
</div>
</body>

</html>